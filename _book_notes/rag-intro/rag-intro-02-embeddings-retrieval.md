---
title: 向量嵌入与语义检索
date: 2026-02-13 11:00:00 +0800
categories: [Reading, Computer Science]
tags: [AI, RAG, 向量嵌入, 语义检索, Embeddings]
layout: book-note
book_id: rag-intro
chapter: 2
summary: 深入探讨向量嵌入技术和语义检索方法，这是构建高质量RAG系统的核心基础。
toc: true
---

> 向量嵌入(Embeddings)是将文本转换为数值向量的技术，它能够捕捉语义信息，使计算机能够理解和比较文本的含义。
{: .prompt-info }

## 向量嵌入基础

### 什么是向量嵌入

向量嵌入是将高维、稀疏的文本数据转换为低维、稠密的连续向量表示的过程。每个向量代表了文本在语义空间中的位置。

**核心特点：**
- **语义相似性**：语义相近的文本在向量空间中距离较近
- **维度固定**：所有文本映射到相同维度的向量空间
- **密集表示**：向量的每个维度都有实际意义

### 向量嵌入的发展历程

#### 1. 传统方法
- **词袋模型(Bag of Words)**：简单但忽略词序
- **TF-IDF**：考虑词频和逆文档频率
- **局限性**：无法捕捉语义，维度过高

#### 2. 分布式表示
- **Word2Vec**：基于上下文学习词向量
  - CBOW模型
  - Skip-gram模型
- **GloVe**：全局词向量表示
- **FastText**：支持子词信息

#### 3. 上下文感知嵌入
- **ELMo**：双向LSTM，上下文相关
- **BERT**：Transformer架构，预训练模型
- **Sentence-BERT**：专门用于句子嵌入

#### 4. 现代嵌入模型
- **OpenAI Embeddings**：text-embedding-ada-002
- **Cohere Embeddings**：多语言支持
- **BGE/E5**：开源高性能嵌入模型

## 嵌入模型的选择

### 评估维度

1. **语义质量**：能否准确捕捉文本含义
2. **维度大小**：向量维度(如384, 768, 1536)
3. **计算效率**：推理速度和资源消耗
4. **领域适配**：通用型 vs 领域专用
5. **多语言支持**：是否支持多种语言

### 常用嵌入模型对比

| 模型           | 维度    | 优势         | 适用场景   |
| -------------- | ------- | ------------ | ---------- |
| OpenAI ada-002 | 1536    | 质量高，易用 | 通用场景   |
| Sentence-BERT  | 384/768 | 开源，可微调 | 自定义需求 |
| BGE-large      | 1024    | 中文效果好   | 中文项目   |
| Cohere Embed   | 1024    | 多语言，快速 | 多语言场景 |

### 选择建议

```python
# 快速原型开发
- 推荐: OpenAI Embeddings
- 优点: 开箱即用，质量稳定
- 缺点: 需要API调用，有成本

# 生产环境部署
- 推荐: 自托管开源模型
- 优点: 成本可控，数据私密
- 缺点: 需要维护基础设施

# 中文场景
- 推荐: BGE系列 或 text2vec
- 优点: 中文优化，效果好
- 缺点: 需要一定技术能力
```

## 语义检索技术

### 检索方法分类

#### 1. 稀疏检索(Sparse Retrieval)
- **代表技术**：BM25, TF-IDF
- **原理**：基于关键词匹配
- **优势**：精确匹配，可解释性强
- **劣势**：词汇鸿沟问题

#### 2. 稠密检索(Dense Retrieval)
- **代表技术**：向量相似度搜索
- **原理**：基于语义相似度
- **优势**：捕捉语义，召回率高
- **劣势**：计算密集

#### 3. 混合检索(Hybrid Retrieval)
- **原理**：结合稀疏和稠密检索
- **策略**：加权融合、重排序
- **优势**：兼具精确性和语义理解
- **实现**：Reciprocal Rank Fusion (RRF)

### 相似度计算

#### 常用距离度量

1. **余弦相似度(Cosine Similarity)**
   ```
   sim(A, B) = (A · B) / (||A|| × ||B||)
   ```
   - 范围：[-1, 1]
   - 适用：归一化向量
   - 优点：对向量长度不敏感

2. **欧氏距离(Euclidean Distance)**
   ```
   dist(A, B) = sqrt(Σ(Ai - Bi)²)
   ```
   - 范围：[0, ∞]
   - 适用：低维空间
   - 缺点：受维度灾难影响

3. **点积相似度(Dot Product)**
   ```
   sim(A, B) = Σ(Ai × Bi)
   ```
   - 范围：(-∞, ∞)
   - 适用：已归一化向量
   - 优点：计算最快

### 检索优化策略

#### 1. 查询优化
- **查询扩展**：添加同义词、相关词
- **查询重写**：使用LLM改写查询
- **多查询**：生成多个查询变体

#### 2. 索引优化
- **分块策略**：合理的文档切分
  - 固定长度切分
  - 语义切分
  - 滑动窗口
- **元数据增强**：添加标题、摘要等信息
- **层次化索引**：构建文档层次结构

#### 3. 后处理优化
- **重排序(Reranking)**：使用更精确的模型重新排序
- **多样性过滤**：避免返回重复内容
- **相关性阈值**：过滤低相关度结果

## 向量数据库

### 主流向量数据库

#### 1. Pinecone
- **特点**：完全托管，易于使用
- **优势**：无需运维，扩展性强
- **适用**：快速原型，生产环境

#### 2. Weaviate
- **特点**：开源，功能丰富
- **优势**：支持混合检索，可自托管
- **适用**：复杂检索需求

#### 3. Milvus
- **特点**：开源，高性能
- **优势**：处理大规模数据，社区活跃
- **适用**：大规模部署

#### 4. Chroma
- **特点**：轻量级，嵌入式
- **优势**：易于集成，开发友好
- **适用**：开发测试，小规模应用

#### 5. Qdrant
- **特点**：Rust实现，高性能
- **优势**：过滤功能强大
- **适用**：需要复杂过滤的场景

### 向量数据库选择指南

```
数据规模小(< 100k) → Chroma
数据规模中等(100k - 1M) → Weaviate/Qdrant
数据规模大(> 1M) → Milvus/Pinecone

需要托管服务 → Pinecone
需要自托管 → Weaviate/Milvus/Qdrant
需要混合检索 → Weaviate
需要强大过滤 → Qdrant
```

## 实践技巧

### 文档分块策略

> **分块是关键**
> 
> 合理的文档分块策略直接影响检索质量。过大的块包含过多噪声，过小的块缺乏上下文。
{: .prompt-tip }

#### 常用策略

1. **固定长度分块**
   ```python
   chunk_size = 512  # tokens
   chunk_overlap = 50  # 重叠部分
   ```

2. **语义分块**
   - 按段落分割
   - 按句子分组
   - 使用语义相似度

3. **滑动窗口**
   - 保留上下文
   - 处理跨块信息

### 嵌入优化

1. **批量处理**：提高吞吐量
2. **缓存机制**：避免重复计算
3. **异步处理**：提升用户体验
4. **增量更新**：只处理新增/修改文档

### 检索调优

1. **Top-K选择**：通常3-5个结果足够
2. **相似度阈值**：过滤低质量结果
3. **重排序**：使用Cross-Encoder提升精度
4. **A/B测试**：持续优化检索效果

## 评估指标

### 检索质量评估

1. **召回率(Recall)**：相关文档被找到的比例
2. **精确率(Precision)**：返回文档的相关性
3. **MRR(Mean Reciprocal Rank)**：相关结果的平均排名
4. **NDCG(Normalized DCG)**：考虑排序的质量指标

### 实践评估方法

```python
# 构建评估集
test_queries = [
    {
        "query": "什么是RAG？",
        "relevant_docs": [doc1, doc2]
    },
    ...
]

# 评估检索效果
for test in test_queries:
    results = retrieve(test["query"])
    calculate_metrics(results, test["relevant_docs"])
```

## 小结

向量嵌入和语义检索是RAG系统的基石。选择合适的嵌入模型、设计高效的检索策略、使用适当的向量数据库，对于构建高质量的RAG应用至关重要。在实践中，需要不断测试和优化，找到最适合特定场景的技术方案。
